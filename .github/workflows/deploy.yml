name: CD (Fake Deploy)

# ğŸ”¥ Executa apenas quando vocÃª aciona manualmente no GitHub
on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    # ğŸŒ± Carrega variÃ¡veis de ambiente vindas do GitHub Secrets
    env:
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      NODE_ENV: ${{ secrets.NODE_ENV }}

    steps:
      # ğŸ“¥ 1. Baixa o cÃ³digo
      - name: Checkout code
        uses: actions/checkout@v4

      # ğŸ³ 2. Instala Docker
      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      # ğŸ™ 3. Instala Docker Compose
      - name: Install Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      # ğŸ—ï¸ 4. Builda e sobe os containers
      - name: Build and run containers
        run: |
          echo "ğŸ”§ Buildando e subindo com docker-compose..."
          docker-compose up -d
          echo "â³ Aguardando a API iniciar..."
          sleep 15

      # âœ… 5. Testa se a API estÃ¡ rodando
      - name: Check API health
        run: |
          echo "ğŸ” Testando se a API estÃ¡ rodando..."
          curl -f http://localhost:3000/health || exit 1
          echo "ğŸ‰ API respondeu com sucesso!"

      # ğŸ§¹ 6. Derruba os containers no final
      - name: Stop containers
        if: always()
        run: |
          echo "ğŸ›‘ Derrubando containers..."
          docker-compose down
