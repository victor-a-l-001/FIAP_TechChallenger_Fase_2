name: CD (Fake Deploy)

# 🔥 Executa apenas quando você aciona manualmente no GitHub
on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    # 🌱 Carrega variáveis de ambiente vindas do GitHub Secrets
    env:
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      NODE_ENV: ${{ secrets.NODE_ENV }}

    steps:
      # 📥 1. Baixa o código
      - name: Checkout code
        uses: actions/checkout@v4

      # 🐳 2. Instala Docker
      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      # 🐙 3. Instala Docker Compose
      - name: Install Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      # 🏗️ 4. Builda e sobe os containers
      - name: Build and run containers
        run: |
          echo "🔧 Buildando e subindo com docker-compose..."
          docker-compose up -d
          echo "⏳ Aguardando a API iniciar..."
          sleep 15

      # ✅ 5. Testa se a API está rodando
      - name: Check API health
        run: |
          echo "🔍 Testando se a API está rodando..."
          curl -f http://localhost:3000/health || exit 1
          echo "🎉 API respondeu com sucesso!"

      # 🧹 6. Derruba os containers no final
      - name: Stop containers
        if: always()
        run: |
          echo "🛑 Derrubando containers..."
          docker-compose down
